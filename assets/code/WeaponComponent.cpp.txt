UWeaponComponent::UWeaponComponent()
{
	PrimaryComponentTick.bCanEverTick = true;

	WeaponMeshComponent = CreateDefaultSubobject<USkeletalMeshComponent>(TEXT("WeaponSkeletalMesh"));
}

void UWeaponComponent::BeginPlay()
{
	Super::BeginPlay();

	Player = Cast<ACharacter>(GetOwner());

	if (IsValid(Player))
	{
		PlayerController = Cast<APlayerController>(Player->GetController());
		CombatManager = Player->FindComponentByClass<UCombatComponent>();
		
		FPSPlayer = Cast<AFPSCharacterBase>(Player);
		USkeletalMeshComponent* CharacterMesh = FPSPlayer->GetFPSArmsMesh();
	}
}

void UWeaponComponent::SetCurrentWeapon(UWeaponDataAsset* Weapon)
{
	if (IsValid(CombatManager))
	{
		E_AmmoType CurrentAmmoType = E_AmmoType::EAT_None;
		CurrentWeaponData = Weapon;
		if (IsValid(CurrentWeaponData))
		{
			CombatManager->SetWeaponReference(this, HandType);
			
			// set ammo type and clip ammo, based on reserve ammo
			CurrentAmmoType = CurrentWeaponData->AmmoType;
			FWeaponInstance& SavedWeaponState = WeaponInstanceMap.FindOrAdd(CurrentWeaponData);

			if (SavedWeaponState.CurrentClipAmmo > 0)
			{
				CurrentClipAmmo = SavedWeaponState.CurrentClipAmmo;
			}
			else
			{
				int32 AmmoToLoad = FMath::Min(CombatManager->GetReserveAmmo(CurrentAmmoType), MaxClipAmmo);
				CurrentClipAmmo = AmmoToLoad;
				CombatManager->RemoveReserveAmmo(CurrentAmmoType, AmmoToLoad);

				// Initialize the saved state for future swaps
				SavedWeaponState.CurrentClipAmmo = CurrentClipAmmo;
			}		

			USkeletalMeshComponent* CharacterMesh = FPSPlayer->GetFPSArmsMesh();
			FName CurrentSocket = (HandType == E_WeaponHand::EWH_LeftHand) ? CurrentWeaponData->WeaponSocketLeft : CurrentWeaponData->WeaponSocketRight;
			if (IsValid(CharacterMesh) && !CurrentSocket.IsNone())
			{
				WeaponMeshComponent->AttachToComponent(CharacterMesh,FAttachmentTransformRules::SnapToTargetNotIncludingScale, CurrentSocket);
				// GEngine->AddOnScreenDebugMessage(1, 5.0f, FColor::Green, FString::Printf(TEXT("Weapon attached to %s"), CurrentSocket.ToString()));
			}
			else 
			{
				GEngine->AddOnScreenDebugMessage(1, 5.0f, FColor::Red, "Weapon attachment failed!");
			}
			WeaponMeshComponent->SetSkeletalMesh(CurrentWeaponData->WeaponMesh);
			// GEngine->AddOnScreenDebugMessage(-1, 5.0f, FColor::Green, FString::Printf(TEXT("New Weapon Equipped")));
		}
		else {
			CurrentClipAmmo = 0;
			WeaponMeshComponent->SetSkeletalMesh(nullptr);
			CombatManager->SetWeaponReference(nullptr, HandType);
		}

		// call delegate to update UI
		OnClipAmmoChanged.Broadcast(CurrentClipAmmo);
	}
}



